<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table of Contents Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .toc-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .content-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .toc-title {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .table-of-contents {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .toc-item {
            border-bottom: 1px solid #eee;
        }
        
        .toc-link {
            display: block;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .toc-link:hover {
            background-color: #f0f0f0;
        }
        
        .toc-link.active {
            background-color: #3498db;
            color: white;
        }
        
        .toc-level-1 {
            font-weight: 600;
        }
        
        .toc-level-2 {
            padding-left: 25px;
            font-weight: 500;
        }
        
        .toc-level-3 {
            padding-left: 40px;
            font-weight: normal;
            font-size: 0.85rem;
        }
        
        .toc-level-4,
        .toc-level-5,
        .toc-level-6 {
            padding-left: 55px;
            font-weight: normal;
            font-size: 0.8rem;
            color: #666;
        }
        
        .no-toc-message {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .test-content {
            line-height: 1.6;
        }
        
        .test-content h1,
        .test-content h2,
        .test-content h3,
        .test-content h4 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .test-content h1 {
            font-size: 2rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }
        
        .test-content h2 {
            font-size: 1.5rem;
            color: #2c3e50;
        }
        
        .test-content h3 {
            font-size: 1.2rem;
            color: #34495e;
        }
        
        .test-content p {
            margin-bottom: 1rem;
            color: #555;
        }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 0 5px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: #e8f4fd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .test-container {
                grid-template-columns: 1fr;
            }
            
            .toc-panel {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Table of Contents Component Test</h1>
        <button class="btn" onclick="generateToc()">生成目录</button>
        <button class="btn" onclick="clearToc()">清空目录</button>
        <button class="btn" onclick="scrollToRandom()">随机跳转</button>
        <button class="btn" onclick="testHighlight()">测试高亮</button>
        <div class="status" id="status">准备就绪</div>
    </div>

    <div class="test-container">
        <div class="toc-panel">
            <h3 class="toc-title">目录</h3>
            <ul class="table-of-contents" id="tableOfContents">
                <li class="no-toc-message">暂无目录</li>
            </ul>
        </div>
        
        <div class="content-panel">
            <div class="test-content" id="testContent">
                <h1 id="intro">介绍</h1>
                <p>这是一个测试页面，用于验证 TableOfContents 组件的功能。该组件应该能够：</p>
                <ul>
                    <li>自动解析标题层级</li>
                    <li>生成可点击的目录结构</li>
                    <li>支持平滑滚动到对应章节</li>
                    <li>自动高亮当前阅读位置</li>
                </ul>

                <h2 id="features">主要功能</h2>
                <p>TableOfContents 组件提供了以下核心功能：</p>

                <h3 id="auto-parsing">自动解析</h3>
                <p>组件能够自动扫描文档中的所有标题元素（h1-h6），并按照层级结构生成目录。对于没有 ID 的标题，会自动生成唯一的标识符。</p>

                <h3 id="navigation">导航功能</h3>
                <p>点击目录中的任意项目，页面会平滑滚动到对应的章节位置。滚动时会考虑固定头部的高度偏移。</p>

                <h4 id="smooth-scroll">平滑滚动</h4>
                <p>使用现代浏览器的 scrollTo API 实现平滑滚动效果，提供更好的用户体验。</p>

                <h4 id="offset-handling">偏移处理</h4>
                <p>考虑到固定头部导航栏的存在，滚动时会自动计算合适的偏移量，确保标题不被遮挡。</p>

                <h3 id="highlighting">自动高亮</h3>
                <p>组件使用 Intersection Observer API 来检测当前可见的标题，并自动高亮目录中对应的项目。</p>

                <h4 id="intersection-observer">Intersection Observer</h4>
                <p>这是一个现代的 Web API，能够高效地监听元素的可见性变化，比传统的滚动监听更加性能友好。</p>

                <h4 id="fallback-scroll">滚动监听回退</h4>
                <p>对于不支持 Intersection Observer 的浏览器，组件提供了基于滚动事件的回退方案。</p>

                <h2 id="implementation">实现细节</h2>
                <p>以下是组件实现的一些技术细节：</p>

                <h3 id="dom-parsing">DOM 解析</h3>
                <p>组件支持解析普通 HTML 元素和 iframe 内容，能够处理跨域限制和文档加载状态。</p>

                <h3 id="event-system">事件系统</h3>
                <p>组件提供了完整的事件系统，包括目录生成、章节跳转、活跃状态变化等事件。</p>

                <h4 id="custom-events">自定义事件</h4>
                <p>所有事件都使用 CustomEvent 实现，便于其他组件监听和响应。</p>

                <h4 id="event-data">事件数据</h4>
                <p>每个事件都携带相关的数据，如标题信息、滚动位置等。</p>

                <h3 id="performance">性能优化</h3>
                <p>组件在多个方面进行了性能优化：</p>

                <h4 id="debouncing">防抖处理</h4>
                <p>滚动事件使用防抖技术，避免频繁触发更新。</p>

                <h4 id="caching">缓存机制</h4>
                <p>解析结果会被缓存，避免重复计算。</p>

                <h4 id="lazy-updates">延迟更新</h4>
                <p>只有在必要时才更新 DOM，减少重绘和重排。</p>

                <h2 id="usage">使用方法</h2>
                <p>以下是组件的基本使用方法：</p>

                <h3 id="initialization">初始化</h3>
                <p>创建 TableOfContents 实例并传入配置选项。</p>

                <h3 id="content-generation">内容生成</h3>
                <p>调用 generateFromContent 方法来生成目录。</p>

                <h4 id="iframe-support">iframe 支持</h4>
                <p>组件完全支持 iframe 内容的目录生成。</p>

                <h4 id="regular-content">普通内容</h4>
                <p>也支持普通 HTML 元素的目录生成。</p>

                <h3 id="customization">自定义配置</h3>
                <p>组件提供了丰富的配置选项来满足不同需求。</p>

                <h2 id="testing">测试验证</h2>
                <p>本页面提供了多种测试功能来验证组件的正确性：</p>

                <h3 id="manual-testing">手动测试</h3>
                <p>通过页面顶部的按钮可以手动触发各种功能。</p>

                <h3 id="automatic-testing">自动测试</h3>
                <p>组件内置了自动测试机制，会在控制台输出详细的日志信息。</p>

                <h4 id="console-logs">控制台日志</h4>
                <p>打开浏览器开发者工具可以查看详细的执行日志。</p>

                <h4 id="error-handling">错误处理</h4>
                <p>组件具有完善的错误处理机制，会优雅地处理各种异常情况。</p>

                <h2 id="conclusion">总结</h2>
                <p>TableOfContents 组件是一个功能完整、性能优化的目录生成解决方案。它支持现代浏览器的最新特性，同时提供了良好的向后兼容性。</p>

                <h3 id="benefits">主要优势</h3>
                <p>组件的主要优势包括：</p>
                <ul>
                    <li>自动化程度高，无需手动配置</li>
                    <li>性能优化，使用现代 Web API</li>
                    <li>兼容性好，提供回退方案</li>
                    <li>可定制性强，支持多种配置</li>
                    <li>事件驱动，便于集成</li>
                </ul>

                <h3 id="future">未来发展</h3>
                <p>组件还可以在以下方面进一步改进：</p>
                <ul>
                    <li>支持更多的标题样式</li>
                    <li>添加搜索功能</li>
                    <li>支持目录折叠</li>
                    <li>添加键盘导航</li>
                    <li>支持主题定制</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 引入组件 -->
    <script src="js/TableOfContents.js"></script>

    <script>
        let tableOfContents = null;
        let testNote = {
            id: 'test',
            title: 'Table of Contents Test',
            content: 'test-content'
        };

        // 初始化
        function init() {
            try {
                tableOfContents = new TableOfContents();
                updateStatus('TableOfContents 组件初始化成功');
                
                // 监听组件事件
                tableOfContents.on('tocGenerated', (event) => {
                    const { toc, headingCount } = event.detail;
                    updateStatus(`目录生成完成，共 ${headingCount} 个标题`);
                });
                
                tableOfContents.on('sectionJump', (event) => {
                    const { headingId } = event.detail;
                    updateStatus(`跳转到章节: ${headingId}`);
                });
                
                tableOfContents.on('activeSectionChange', (event) => {
                    const { headingId } = event.detail;
                    updateStatus(`当前活跃章节: ${headingId}`);
                });
                
                // 自动生成目录
                setTimeout(() => {
                    generateToc();
                }, 500);
                
            } catch (error) {
                updateStatus('初始化失败: ' + error.message);
                console.error('Initialization failed:', error);
            }
        }

        // 生成目录
        function generateToc() {
            if (!tableOfContents) {
                updateStatus('TableOfContents 组件未初始化');
                return;
            }
            
            try {
                const contentElement = document.getElementById('testContent');
                const toc = tableOfContents.generateFromContent(testNote, contentElement);
                updateStatus(`目录生成成功，共 ${toc.length} 个标题`);
            } catch (error) {
                updateStatus('目录生成失败: ' + error.message);
                console.error('TOC generation failed:', error);
            }
        }

        // 清空目录
        function clearToc() {
            if (!tableOfContents) {
                updateStatus('TableOfContents 组件未初始化');
                return;
            }
            
            tableOfContents.clear();
            updateStatus('目录已清空');
        }

        // 随机跳转
        function scrollToRandom() {
            if (!tableOfContents || !tableOfContents.currentToc.length) {
                updateStatus('没有可用的目录项');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * tableOfContents.currentToc.length);
            const randomItem = tableOfContents.currentToc[randomIndex];
            
            tableOfContents.scrollToHeading(randomItem.id, randomItem.index);
            updateStatus(`随机跳转到: ${randomItem.text}`);
        }

        // 测试高亮功能
        function testHighlight() {
            if (!tableOfContents || !tableOfContents.currentToc.length) {
                updateStatus('没有可用的目录项');
                return;
            }
            
            // 依次高亮每个章节
            let index = 0;
            const highlightNext = () => {
                if (index < tableOfContents.currentToc.length) {
                    const item = tableOfContents.currentToc[index];
                    tableOfContents.setActiveSection(item.id);
                    updateStatus(`高亮测试: ${item.text} (${index + 1}/${tableOfContents.currentToc.length})`);
                    index++;
                    setTimeout(highlightNext, 1000);
                } else {
                    updateStatus('高亮测试完成');
                }
            };
            
            highlightNext();
        }

        // 更新状态显示
        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            console.log('Status:', message);
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>