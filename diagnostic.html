<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Component Diagnostic</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .diagnostic-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ddd;
        }
        
        .test-item.success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .test-item.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .test-item.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .test-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .test-details {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>Component Diagnostic Test</h1>
        <p>This page tests if all components are loading and initializing correctly.</p>
        
        <button class="btn" onclick="runDiagnostic()">Run Diagnostic</button>
        <button class="btn" onclick="clearResults()">Clear Results</button>
        
        <div id="results"></div>
    </div>

    <!-- 引入所有组件 -->
    <script src="js/StyleProcessor.js"></script>
    <script src="js/TableOfContents.js"></script>
    <script src="js/LayoutManager.js"></script>
    <script src="js/MobileMenu.js"></script>
    <script src="js/NoteRenderer.js"></script>

    <script>
        function runDiagnostic() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Diagnostic Results</h2>';
            
            const tests = [
                {
                    name: 'StyleProcessor Class',
                    test: () => typeof StyleProcessor !== 'undefined',
                    details: 'Checks if StyleProcessor class is available'
                },
                {
                    name: 'TableOfContents Class',
                    test: () => typeof TableOfContents !== 'undefined',
                    details: 'Checks if TableOfContents class is available'
                },
                {
                    name: 'LayoutManager Class',
                    test: () => typeof LayoutManager !== 'undefined',
                    details: 'Checks if LayoutManager class is available'
                },
                {
                    name: 'MobileMenu Class',
                    test: () => typeof MobileMenu !== 'undefined',
                    details: 'Checks if MobileMenu class is available'
                },
                {
                    name: 'NoteRenderer Class',
                    test: () => typeof NoteRenderer !== 'undefined',
                    details: 'Checks if NoteRenderer class is available'
                },
                {
                    name: 'StyleProcessor Initialization',
                    test: () => {
                        try {
                            const sp = new StyleProcessor();
                            return sp && typeof sp.applyUnifiedStyles === 'function';
                        } catch (e) {
                            return false;
                        }
                    },
                    details: 'Tests StyleProcessor instantiation and basic methods'
                },
                {
                    name: 'TableOfContents Initialization',
                    test: () => {
                        try {
                            const toc = new TableOfContents();
                            return toc && typeof toc.generateFromContent === 'function';
                        } catch (e) {
                            return false;
                        }
                    },
                    details: 'Tests TableOfContents instantiation and basic methods'
                },
                {
                    name: 'LayoutManager Initialization',
                    test: () => {
                        try {
                            // Create a mock DOM structure for testing
                            const mockSidebar = document.createElement('div');
                            mockSidebar.id = 'sidebar';
                            const mockMainContent = document.createElement('div');
                            mockMainContent.id = 'mainContent';
                            const mockAppContainer = document.createElement('div');
                            mockAppContainer.className = 'app-container';
                            
                            document.body.appendChild(mockSidebar);
                            document.body.appendChild(mockMainContent);
                            document.body.appendChild(mockAppContainer);
                            
                            const lm = new LayoutManager();
                            const result = lm && typeof lm.detectScreenSize === 'function';
                            
                            // Clean up
                            document.body.removeChild(mockSidebar);
                            document.body.removeChild(mockMainContent);
                            document.body.removeChild(mockAppContainer);
                            
                            return result;
                        } catch (e) {
                            console.error('LayoutManager test error:', e);
                            return false;
                        }
                    },
                    details: 'Tests LayoutManager instantiation with mock DOM elements'
                },
                {
                    name: 'NoteRenderer Initialization',
                    test: () => {
                        try {
                            // Set up required global dependencies
                            window.styleProcessor = new StyleProcessor();
                            
                            const nr = new NoteRenderer();
                            return nr && typeof nr.loadNote === 'function';
                        } catch (e) {
                            console.error('NoteRenderer test error:', e);
                            return false;
                        }
                    },
                    details: 'Tests NoteRenderer instantiation with dependencies'
                },
                {
                    name: 'Component Integration',
                    test: () => {
                        try {
                            window.styleProcessor = new StyleProcessor();
                            const nr = new NoteRenderer();
                            return nr.tableOfContents && typeof nr.tableOfContents.generateFromContent === 'function';
                        } catch (e) {
                            console.error('Integration test error:', e);
                            return false;
                        }
                    },
                    details: 'Tests if NoteRenderer properly integrates with TableOfContents'
                },
                {
                    name: 'DOM Requirements',
                    test: () => {
                        const requiredElements = [
                            'tableOfContents'
                        ];
                        
                        // Create missing elements for testing
                        const missingElements = [];
                        requiredElements.forEach(id => {
                            if (!document.getElementById(id)) {
                                const elem = document.createElement('ul');
                                elem.id = id;
                                document.body.appendChild(elem);
                                missingElements.push(elem);
                            }
                        });
                        
                        const result = requiredElements.every(id => document.getElementById(id) !== null);
                        
                        // Clean up created elements
                        missingElements.forEach(elem => document.body.removeChild(elem));
                        
                        return result;
                    },
                    details: 'Checks if required DOM elements can be created'
                }
            ];
            
            tests.forEach(test => {
                const testResult = document.createElement('div');
                testResult.className = 'test-item';
                
                try {
                    const passed = test.test();
                    testResult.classList.add(passed ? 'success' : 'error');
                    
                    testResult.innerHTML = `
                        <div class="test-name">${test.name}: ${passed ? '✅ PASS' : '❌ FAIL'}</div>
                        <div class="test-details">${test.details}</div>
                    `;
                } catch (error) {
                    testResult.classList.add('error');
                    testResult.innerHTML = `
                        <div class="test-name">${test.name}: ❌ ERROR</div>
                        <div class="test-details">${test.details}<br>Error: ${error.message}</div>
                    `;
                }
                
                results.appendChild(testResult);
            });
            
            // Summary
            const summary = document.createElement('div');
            summary.className = 'test-item';
            summary.style.marginTop = '30px';
            summary.style.borderLeft = '4px solid #17a2b8';
            summary.style.backgroundColor = '#d1ecf1';
            summary.style.color = '#0c5460';
            
            const passedTests = results.querySelectorAll('.success').length;
            const totalTests = tests.length;
            
            summary.innerHTML = `
                <div class="test-name">Summary: ${passedTests}/${totalTests} tests passed</div>
                <div class="test-details">
                    ${passedTests === totalTests ? 
                        'All components are working correctly! ✅' : 
                        'Some components have issues. Check the failed tests above. ⚠️'
                    }
                </div>
            `;
            
            results.appendChild(summary);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Auto-run diagnostic on page load
        window.addEventListener('load', () => {
            setTimeout(runDiagnostic, 500);
        });
    </script>
</body>
</html>